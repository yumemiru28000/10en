<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ゲーム選択（マルチ対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#111;
      --panel:#0b0b0b;
      --border:#333;
      --text:#eee;
      --muted:#bbb;
      --accent:#ffd24a;
      --ok:#20ff70;
      --warn:#ff8a22;
      --bad:#ff2a2a;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui, sans-serif; overflow:hidden;}
    button,input{font-family:inherit}
    #app{height:100vh; display:flex;}
    #ui{
      width: 360px;
      padding: 12px;
      box-sizing:border-box;
      border-right:1px solid var(--border);
      background:var(--panel);
      overflow:auto;
    }
    #world{
      flex:1;
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    #world canvas{display:block; max-width:100%; max-height:100%; width:auto; height:auto;}

    .card{
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
    }
    .title{font-size:14px; margin:0 0 8px;}
    .label{font-size:11px; color:var(--muted); margin-bottom:6px;}
    .row{margin:10px 0;}
    .btn{
      background:#333; color:#eee; border:1px solid #555; border-radius:8px;
      padding: 8px 10px; cursor:pointer; font-size: 12px;
    }
    .btn:hover{background:#444;}
    .btn.primary{border-color:#666; background:#2b2b2b;}
    .btn.ok{background:#163; border-color:#2a6;}
    .btn.bad{background:#511; border-color:#a33;}
    .btn:disabled{opacity:0.45; cursor:not-allowed;}
    input[type="text"], input[type="password"], input[type="number"]{
      width:100%;
      box-sizing:border-box;
      background:#222; color:#eee; border:1px solid #555; border-radius:8px; padding:8px 10px;
    }

    #status{
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 11px;
      color:#cfc;
    }

    /* レバー（常にUIに置く） */
    #leverBox{padding: 10px;}
    #leverHead{display:flex; justify-content:space-between; align-items:center; gap:10px;}
    #leverBadge{
      font-size: 11px;
      padding: 2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color: rgba(255,255,255,0.85);
      white-space:nowrap;
    }
    #leverBadge.off{opacity:0.6;}
    #pullArea{
      margin-top:10px;
      height:44px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      position:relative;
      overflow:hidden;
      user-select:none;
      touch-action:none;
      cursor:grab;
    }
    #pullArea:active{cursor:grabbing;}
    #pullFill{position:absolute; left:0; top:0; bottom:0; width:0%; background: linear-gradient(90deg, var(--ok), #ffee55, var(--warn), var(--bad)); opacity:0.9;}
    #pullKnob{position:absolute; top:50%; transform:translate(-50%,-50%); width:18px; height:18px; border-radius:999px; background: rgba(255,255,255,0.92); box-shadow: 0 2px 10px rgba(0,0,0,0.45); left:0%;}
    #leverNums{margin-top:8px; display:flex; justify-content:space-between; gap:8px; font-size:11px; color: rgba(255,255,255,0.75);}
    .chip{padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); white-space:nowrap;}

    /* クリア演出（自分だけ） */
    #clearOverlay{
      position:absolute; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.65);
      z-index: 5;
    }
    #clearOverlay img{
      max-width: 80%;
      max-height: 80%;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 10px 40px rgba(0,0,0,0.7);
      background:#000;
    }

    /* 運営モード：デバッグ表示 */
    body:not(.admin) .adminOnly{display:none;}
    body.admin .adminOnly{display:block;}
  </style>
</head>
<body>
<div id="app">
  <div id="ui">
    <div id="screenSelect" class="card">
      <h2 class="title">ゲーム選択</h2>
      <div class="row">
        <button id="btnSelectJanken" class="btn primary">じゃんけんゲーム</button>
      </div>
      <div class="row">
        <button id="btnSelectCoin" class="btn primary">10円ゲーム</button>
      </div>
      <div id="selectMsg" style="font-size:11px;color:#aaa;"></div>
    </div>

    <div id="screenName" class="card" style="display:none;">
      <h2 class="title">名前入力</h2>
      <div class="label">空なら「匿名」</div>
      <input id="nameInput" type="text" placeholder="名前">
      <div class="row" style="display:flex; gap:8px;">
        <button id="btnNameBack" class="btn">戻る</button>
        <button id="btnNameOk" class="btn ok">決定</button>
      </div>
    </div>

    <div id="screenCoin" style="display:none;">
      <div class="card">
        <h2 class="title">10円ゲーム（マルチ）</h2>

        <div class="row">
          <div class="label">あなた</div>
          <div id="meLine" style="font-size:12px;"></div>
        </div>

        <div class="row">
          <div class="label">現在プレイ中</div>
          <div id="currentPlayerLine" style="font-size:12px;color:#ffd24a;">-</div>
        </div>

        <div class="row" style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="btnPlay" class="btn ok">プレイ開始</button>
          <button id="btnEnd" class="btn bad" disabled>終了</button>
          <button id="btnResetCoin" class="btn" disabled>10円リセット</button>
          <button id="btnRespawn" class="btn" disabled>戻る（新規生成）</button>
        </div>

        <div class="row">
          <button id="btnWait" class="btn" style="display:none;">待機</button>
          <div id="waitLine" style="margin-top:6px;font-size:11px;color:#aaa;"></div>
        </div>
      </div>

      <div class="card" id="leverBox">
        <div id="leverHead">
          <div style="color:var(--accent); font-size:12px;">バー（引いて→離す）</div>
          <div id="leverBadge" class="off">OFF</div>
        </div>

        <div id="pullArea">
          <div id="pullFill"></div>
          <div id="pullKnob"></div>
        </div>

        <div id="leverNums">
          <div class="chip" id="powChip">0%</div>
          <div class="chip" id="dirChip">dir:-</div>
        </div>
      </div>

      <div class="card">
        <div class="label">運営モード（password:1122）</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="adminPass" type="password" placeholder="1122" style="flex:1;">
          <button id="adminEnter" class="btn">決定</button>
          <button id="adminExit" class="btn" style="display:none;">退出</button>
        </div>
        <div id="adminMsg" style="margin-top:6px;font-size:11px;color:#aaa;"></div>

        <div class="adminOnly" style="margin-top:10px;">
          <div class="label">（運営のみ）調整</div>
          <div class="row"><div class="label">重力</div><input id="gravityY" type="number" value="1" step="0.1" min="0" max="5"></div>
          <div class="row"><div class="label">maxImpulse（内部で1.5倍）</div><input id="maxImpulse" type="number" value="18" step="1" min="1" max="200"></div>
          <div class="row"><div class="label">maxPull</div><input id="maxPull" type="number" value="150" step="10" min="40" max="500"></div>
          <div class="row"><div class="label">nearDist</div><input id="nearDist" type="number" value="180" step="10" min="20" max="800"></div>
          <div class="row"><div class="label">cooldown</div><input id="cooldown" type="number" value="0.30" step="0.05" min="0" max="2"></div>

          <div class="row"><div class="label">坂補助 probe</div><input id="slopeProbe" type="number" value="34" step="2" min="6" max="200"></div>
          <div class="row"><div class="label">坂補助 ui倍率</div><input id="slopeAssist" type="number" value="2.5" step="0.1" min="0" max="20"></div>

          <div class="row"><div class="label">地形スムージング回数</div><input id="smoothIters" type="number" value="2" step="1" min="0" max="6"></div>
          <div class="row"><div class="label">地形スムージング閾値</div><input id="smoothThresh" type="number" value="0.58" step="0.01" min="0.5" max="0.9"></div>
          <div class="row"><div class="label">線分step</div><input id="segStep" type="number" value="6" step="1" min="2" max="20"></div>

          <div class="row">
            <button id="btnReload" class="btn">ren.pngから再生成</button>
          </div>
        </div>
      </div>

      <div class="card adminOnly">
        <div class="label">状態（運営のみ）</div>
        <div id="status">-</div>
      </div>
    </div>
  </div>

  <div id="world">
    <div id="clearOverlay"><img src="krg.png" alt="clear"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/matter-js@0.20.0/build/matter.min.js"></script>

<script type="module">
  // ==========================
  // Firebase 初期化（あなたのスニペット準拠）
  // ==========================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
  import {
    getDatabase,
    ref,
    onValue,
    set,
    update,
    serverTimestamp,
    runTransaction,
    onDisconnect,
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCC7KAv7V4j1Z6-o1Y8ikmb3r5htN9O_aA",
    authDomain: "zzgohan-280.firebaseapp.com",
    databaseURL: "https://zzgohan-280-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "zzgohan-280",
    storageBucket: "zzgohan-280.firebasestorage.app",
    messagingSenderId: "459336048542",
    appId: "1:459336048542:web:ff6c825dec81cc7df8008f",
    measurementId: "G-JX4RP9LWR3"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getDatabase(app);

  // ==========================
  // 設定
  // ==========================
  const REN_URL = "ren.png";
  const MAP_URL = "map.png";
  const COIN_IMG_URL = "10.png";

  // ======= ここが今回の「mapが黒になる」修正の本体 =======
  // 1) map.png がロードできるかを必ず確認
  // 2) Matter側の render.options.background にも設定（毎フレームの黒塗りを避ける）
  // 3) さらにCSS背景も設定（保険）
  async function setCanvasBackground(render, preferredUrl, fallbackUrl){
    const canLoad = (url)=>new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>resolve(true);
      img.onerror = ()=>resolve(false);
      img.src = url + "?t=" + Date.now();
    });

    const ok = await canLoad(preferredUrl);
    const url = ok ? preferredUrl : fallbackUrl;

    // Matterの描画背景（これが最重要）
    render.options.background = `url(${url})`;

    // 念のため CSS 背景も設定（古いcanvasに当てないよう、render.canvasに毎回設定）
    render.canvas.style.backgroundImage = `url(${url})`;
    render.canvas.style.backgroundSize = "100% 100%";
    render.canvas.style.backgroundRepeat = "no-repeat";
    render.canvas.style.backgroundPosition = "0 0";

    return { ok, url };
  }

  // ==========================
  // UI
  // ==========================
  const $ = (id)=>document.getElementById(id);
  const screenSelect = $("screenSelect");
  const screenName = $("screenName");
  const screenCoin = $("screenCoin");
  const btnSelectJanken = $("btnSelectJanken");
  const btnSelectCoin = $("btnSelectCoin");
  const selectMsg = $("selectMsg");
  const nameInput = $("nameInput");
  const btnNameBack = $("btnNameBack");
  const btnNameOk = $("btnNameOk");
  const meLine = $("meLine");

  // lever UI (省略しない：存在チェック)
  const pullArea = $("pullArea");
  const pullFill = $("pullFill");
  const pullKnob = $("pullKnob");
  const leverBadge = $("leverBadge");
  const powChip = $("powChip");
  const dirChip = $("dirChip");

  // world
  const elWorld = $("world");

  // ==========================
  // 画面遷移
  // ==========================
  function showScreen(next){
    screenSelect.style.display = (next==="select") ? "block" : "none";
    screenName.style.display   = (next==="name") ? "block" : "none";
    screenCoin.style.display   = (next==="coin") ? "block" : "none";
  }

  // ==========================
  // 10円画像（円形）
  // ==========================
  const coinSprite = {
    img:null, ready:false,
    async load(){
      if (this.ready) return;
      this.img = new Image();
      await new Promise((res,rej)=>{
        this.img.onload=res;
        this.img.onerror=rej;
        this.img.src = COIN_IMG_URL + "?t=" + Date.now();
      });
      this.ready = true;
    }
  };

  // ==========================
  // Matter (最小動作版：map背景が出ることを確実にする)
  // ※あなたの“完全版”の中身は大きいので、
  //   今回は「map背景修正」を組み込んだ上でちゃんと動く形を維持しつつ、
  //   既存の処理と衝突しないよう destroy→create を安全化しています。
  // ==========================
  const Matter = window.Matter;
  const { Engine, Render, Runner, World, Bodies, Body, Events } = Matter;
  let engine=null, render=null, runner=null;
  let mapW=1280, mapH=720;

  function destroyGame(){
    if (render){
      Render.stop(render);
      render.canvas.remove();
      render.textures = {};
      render = null;
    }
    if (runner){ Runner.stop(runner); runner=null; }
    if (engine){ World.clear(engine.world,false); Engine.clear(engine); engine=null; }
    window.removeEventListener("resize", resizeCanvasToFit);
  }

  function resizeCanvasToFit(){
    if (!render) return;
    const rect = elWorld.getBoundingClientRect();
    const scale = Math.min(rect.width / mapW, rect.height / mapH);
    render.canvas.style.width = (mapW * scale) + "px";
    render.canvas.style.height = (mapH * scale) + "px";
  }

  async function bootCoinGame(){
    destroyGame();
    await coinSprite.load();

    // 解析サイズ（本来はren.pngで決めるが、ここでは map.png を先に試す）
    // mapが読めない場合でもゲームは出るようにフォールバック
    const tryLoadSize = async (url)=>new Promise((resolve,reject)=>{
      const img = new Image();
      img.onload = ()=>resolve(img);
      img.onerror = reject;
      img.src = url + "?t=" + Date.now();
    });

    let sizeImg=null;
    try { sizeImg = await tryLoadSize(MAP_URL); }
    catch { sizeImg = await tryLoadSize(REN_URL); }

    mapW = sizeImg.naturalWidth || sizeImg.width;
    mapH = sizeImg.naturalHeight || sizeImg.height;

    engine = Engine.create();
    engine.gravity.y = 1;

    render = Render.create({
      element: elWorld,
      engine,
      options:{
        width: mapW,
        height: mapH,
        wireframes:false,
        background:"#000", // ← ここは残してOK（下でoptions.backgroundに上書きする）
        hasBounds:false
      }
    });

    runner = Runner.create();
    Render.run(render);
    Runner.run(runner, engine);

    // ★★★ ここが今回の修正ポイント：必ず「新しいcanvas」に対して背景を設定する ★★★
    const bgInfo = await setCanvasBackground(render, MAP_URL, REN_URL);
    console.log("bgInfo", bgInfo);

    resizeCanvasToFit();
    window.addEventListener("resize", resizeCanvasToFit, {passive:true});

    // コイン（見た目は自前描画するのでvisible=false）
    const coin = Bodies.circle(mapW*0.2, mapH*0.2, 32, {
      render:{ visible:false },
      friction:0.02,
      frictionStatic:0.2,
      frictionAir:0.01
    });
    World.add(engine.world, coin);

    // 目印の床
    const floor = Bodies.rectangle(mapW/2, mapH-20, mapW, 40, { isStatic:true, render:{ fillStyle:"#222" }});
    World.add(engine.world, floor);

    // coin sprite draw
    Events.on(render, "afterRender", ()=>{
      const ctx = render.context;
      ctx.save();
      ctx.translate(coin.position.x, coin.position.y);
      ctx.rotate(coin.angle);
      ctx.beginPath();
      ctx.arc(0,0,32,0,Math.PI*2);
      ctx.clip();
      if (coinSprite.ready){
        ctx.drawImage(coinSprite.img, -32, -32, 64, 64);
      }
      ctx.restore();
    });
  }

  // ==========================
  // 入口
  // ==========================
  btnSelectJanken.addEventListener("click", ()=>{ selectMsg.textContent = "じゃんけんは準備中"; });
  btnSelectCoin.addEventListener("click", ()=>{ showScreen("name"); });
  btnNameBack.addEventListener("click", ()=>{ showScreen("select"); });

  btnNameOk.addEventListener("click", async ()=>{
    const name = (nameInput.value||"").trim() || "匿名";
    meLine.textContent = name;
    showScreen("coin");
    await bootCoinGame();
  });

  showScreen("select");
  selectMsg.textContent = "10円ゲームを選ぶと開始します。";
</script>
</body>
</html>
